
# Development

## Summary

* Create a branch
* Make changes
* Document your change
* Submit a pull request
* Develop principles: Checklist before submitting a request.

## Create a branch

* Want to make changes: fork the repo (see installation)and submit pull requests, see [creating-a-pull-request-from-a-fork](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork):

    * Press Branches, press New Branch, give it a name e.g. background-script and press Create new Branch, click on background-script
      
      <img width="90" src="https://github.com/user-attachments/assets/588d0854-bac1-4b70-8931-ba6db4c94248" />

## Make changes

### Front End (UI)

* interface folder
    * interface/src/routes/moonbase for MoonBase and MoonLight (modules)
* see [Prepare for development](https://moonmodules.org/MoonLight/develop/installation/#prepare-for-development) about nodejs, npm install

```
npm install
npm run dev
```

* see [Troubleshooting](https://moonmodules.org/MoonLight/develop/installation/#troubleshooting) about WWWData.h

### Back End (Server)

There are 3 levels to add functionality:

* **Standard ESP32-Sveltekit code**, e.g. Connections, Wifi and System. MoonBase files is also made using standard sveltekit as example but contains a few components used in MoonLight modules. Might be rewriteen as MoonLight Module in the future.
  * lib folder for Sveltekit back end
  * Read the [ESP32 Sveltekit docs](https://moonmodules.org/MoonLight/esp32sveltekit/)
* [MoonLight Modules](https://moonmodules.org/MoonLight/moonbase/modules/) e.g. Lights Control, Effects, Info, Channels. They are subclasses of Modules.h/cpp and implement setupDefinition, onUpdate and optional loop. New modules need to be defined in main.cpp and added to menu.svelte. All further UI is generated by Module.svelte.
  * src folder for MoonBase and MoonLight back end
* **MoonLight Nodes**: the easiest and recommended way. See Effects.h, Layouts.h, Modifiers.h and Drivers.h for examples. They match closest WLED usermods. Each node has controls, a setup and a loop and can be switched on and off. For specific purposes hasOnLayout() and hasModifier() can return true.
  * src/MoonLight/nodes

### Steps

* Go to the file(s) you want to change press edit and make the changes. 
* ‚òëÔ∏è and ‚û°Ô∏è to build and or upload
* Changes made to the UI are not always visible in the browser, clear the browser cache to see latest UI (see [connect to MoonLight](https://moonmodules.org/MoonLight/gettingstarted/installation/#connect-moonlight)).
* MoonLight uses clang-format for c/c++ code and prettier for Svelte, javascript etc. Format your code before submitting! (right click Format Document on each page you change)
* Press Commit Changes..., enter a commit message and an extended description, Press Commit Changes

## Document your changes

See [Documentation](https://moonmodules.org/MoonLight/develop/documentation/)

## Submit a pull request

    * Go back to the homepage of your fork [myfork/MoonLight](https://github.com/ewowi/MoonLight). There is a message inviting to create a Pull Request. Press Compare & pull request.
      
      <img width="350" alt="Screenshot 2025-04-15 at 14 59 15" src="https://github.com/user-attachments/assets/410aa517-99eb-4907-b1a3-db7f38abb194" />
  
    * Add a title and Description to the Pull Request and press Create Pull Request
  
    * The upstream MoonLight repo can now process this PR

## Addtional info

### Emoji coding

* Serial Log shows which code is from which library using emoji:

   <img width="500" alt="Screenshot 2025-06-07 at 12 09 06" src="https://github.com/user-attachments/assets/9ac673d3-6303-40ee-b2a0-26a0befbda01" />

    * üêº: ESP-SvelteKit
    * üîÆ: PsychicHTTP
    * üê∏: Live Scripts
    * üåô: MoonBase
    * üí´: MoonLight
    üåô and üí´ is also used in code comments of ESP32-SvelteKit to show where changes to upstream have been made.
* The following ESP32-SvelteKit features have been switched off in the default builts (they can be switched on if you want to use them, see [features.ini](https://github.com/MoonModules/MoonLight/blob/main/features.ini))
    *   -D FT_SECURITY=0
    *   -D FT_SLEEP=0
    *   ~~-D FT_BATTERY=1~~ enabled!

### UI development server

To ease the frontend development you can deploy the back end code on an ESP32 board and pass the websocket and REST API calls through the development server's proxy running on your computer.

This very much speeds up UI development as no flashing to ESP32 is required to test updated UI. Svaing an UI file is enough to see the results!!!

See [Setup Proxy for Development](https://moonmodules.org/MoonLight/gettingstarted/#setup-proxy-for-development) and [development-server](https://moonmodules.org/MoonLight/gettingstarted/#development-server) how to setup.

!!! tip "nodejs" 
     if nodejs is not installed yet: see [Prepare for development](https://moonmodules.org/MoonLight/develop/installation/#prepare-for-development) to install nodejs

After configuring the development server, a local webserver starts on [localhost:5173](http://localhost:5173/). 

### Release and merged firmware binaries

Firmware binaries come in 2 flavours: including boot and partition (merged) and MoonLight code only (release). They are stored in the build folder of the MoonLight repo and updated each time a build or upload (‚òëÔ∏è or ‚û°Ô∏è) is done. Subfolder merged contains the first type, release the second type.

* Merged bins are used by the [MoonLight Installer](https://moonmodules.org/MoonLight/gettingstarted/installer/), release bins by the [System update](https://moonmodules.org/MoonLight/system/update/) module (OTA). System update uses the bins stored in [GitHub releases](https://github.com/MoonModules/MoonLight/releases).
* Merged bins starts flashing on address 0x0, release bins on address 0x10000.
* All MoonLight partition schemes have a firmware size of 3MB. Smaller devices (e.g. ESP32-D0) have no OTA partition. System update is possible in this situation, but there is no fallback if update fails (need to flash using USB in that case) üöß

!!! tip "flash firmware using esptool"
     * [>_] in the statusbar of vscode
     ```
     esptool --port /dev/cu.usbmodem11201 write-flash 0x0 ./build/merged/MoonLight_esp32-s3-devkitc-1-n16r8v_0-6-0_webflash.bin
     ```
     * optionally add erase-flash before write-flash
     * use ./build/release/MoonLight_esp32-s3-devkitc-1-n16r8v_0-6-0.bin and address 0x10000 to flash only the MoonLight partition

### Adding an ESP32 device Definition

Before starting, ensure you have the datasheet of your particular chip and ESP32-device confirmed and available. Many modules have near-identical markings that can hide varying hardware.

There are 3 files to consider when making a ESP32-device definition.

	boards/BOARD_NAME.csv
	boards/BOARD_NAME.JSON
	firmware/BOARD_TYPE_NAME.ini (e.g. esp32dev, esp32-s3), contains different boards

## Develop principles

* One firmware per board containing everything, to keep management of firmware simple - for everybody. 3MB flash space to allow for this.
* Clang-format and Prettier for unified layout of code (right click format document in VSCode)
* Part of submitting a change via a pull request is updated documentation. Functionality and documentation should be in one Pull Request 
* Make minimal changes in upstream (Sveltekit) code, as we need to stay in sync as easy as possible. Add // üåô to show a change has been made.
* The main branch is the source to branch and merge to, no direct code commits to the main branch. As the main branch docs folder is the source for the website, doc changes can be made directly to main. 
* The dev branch is used for latest updates between releases. Optionally branch from dev if latest updates are needed for a change.
* The src folder is for all MoonBase and MoonLight Nodes and Modules development. No need for UI changes as that is generated for Nodes and Modules. The lib folder is for upstream (Sveltekit). The interface folder is for UI, mainly Sveltekit and Modules and Nodes generic functions.
* A pull request should contain compilable code and tested to not crash the system at minimal and support also boards without PSRAM, e.g. ESP32-D0. Code may be work in progress.
